<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>User registration information page</title>
    <meta charset="utf-8" />

    <link rel="stylesheet" type="text/css" href="css/EditUserInfoPage.css">

    <!-- 引入jQuery库 -->
    <script src="jquery-3.7.1.js"></script>
    <!-- 引入Bootstrap样式库 -->
    <link rel="stylesheet" href="bootstrap/css/bootstrap.min.css" />
    <!-- 引入Bootstrap JS库 -->
    <script src="bootstrap/js/bootstrap.bundle.min.js"></script>

</head>

<body style="background: whitesmoke" class="body">
    <div class="container-row" style="text-align: center">
        <font face="" color="black" size="7">User registration information page</font>

    </div>


<div class="container my-4">
    <h2><i style="padding-right: 100px">User list</i>
        <button onclick="showAddModal()" id="add" class="btn btn-primary layui-btn-fluid">Add</button>
        <input type="text" id="search-input" placeholder="Please enter ID" >
        <button class="btn btn-primary btn-large" >Search</button></h2>



    <table id="studentTable" class="table table-striped">
        <thead>
        <tr>
            <th>ID</th>
            <th>Username</th>
            <th>Position</th>
            <th>Mobile Number</th>
            <th>Gender</th>
            <th>School email</th>
            <th>Emergency contact number</th>
            <th>operate</th>
        </tr>
        </thead>
        <tbody id="studentTableBody">
        <!-- 学生信息将由JavaScript动态添加到表格中 -->
        </tbody>
    </table>

    <!-- 弹出添加/更新学生信息的模态框 -->
    <div id="studentModal" class="modal">
        <h2 id="modalTitle"></h2>
        <form id="studentForm">
            <div class="input-box-wrpper">
                <div class="box1">

                    <form>
                        <div class="mb-3">
                            <label for="id" class="form-label">Id</label>
                            <input  type="text" class="form-control" id="id" name="id" />
                        </div>
                        <div class="mb-3">
                            <label for="username" class="form-label">Username</label>
                            <input  type="text" class="form-control" id="username" name="username" />
                        </div>
                        <div class="mb-3">
                            <label for="position" class="form-label">Position</label>
                            <select  class="form-control" aria-label="Default select example" id="position" name="position">
                                <option value="Staff">Staff</option>
                                <option value="Student">Student</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="mobilePhone" class="form-label">mobile phone</label>
                            <input  type="text" class="form-control" id="mobilePhone" name="mobilePhone" />
                        </div>
                        <div class="mb-3">
                            <label for="gender" class="form-label">gender</label>
                            <select class="form-control" aria-label="Default select example" id="gender" name="gender">
                                <option value="male">male</option>
                                <option value="female">female</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="schoolEmail" class="form-label">School email</label>
                            <input  type="text" class="form-control" id="schoolEmail" name="schoolEmail" />
                        </div>
                        <div class="mb-3">
                            <label for="emergencyContactNumber" class="form-label">Emergency contact phone</label>
                            <input  type="text" class="form-control" id="emergencyContactNumber" name="emergencyContactNumber" />
                        </div>

                    </form>
                </div>
            <div>
                <button type="submit"  id="saveButton" class="btn btn-primary btn-sm">Submit</button>
                <button type="button" onclick="closeModal()" class="btn btn-primary btn-sm">Close</button>
            </div>
            </div>
        </form>
    </div>


    <script>

        // 获取学生信息并渲染到表格中
        function fetchAndRenderStudents() {
            fetch('http://localhost:8080/api/StuInfo')
                .then(response => response.json())
                .then(data => {
                    renderStudents(data);
                    bindDeleteButtonListeners();
                })
                .catch(error => console.error('Error fetching students', error));
        }

        function renderStudents(students) {
            var tableBody = document.querySelector('#studentTable tbody');
            tableBody.innerHTML = '';
            students.forEach(function (student) {
                var row = `<tr>
            <td>${student.id}</td>
            <td>${student.username}</td>
            <td>${student.position}</td>
            <td>${student.mobilePhone}</td>
            <td>${student.gender}</td>
            <td>${student.schoolEmail}</td>
            <td>${student.emergencyContactNumber}</td>
            <td>
                <button onclick="openEditModal(${student.id})">Update</button>
                <button onclick="deleteStudent(${student.id})" class="delete-button" data-student-id="${student.id}">Delete</button>

            </td>
        </tr>`;
                tableBody.innerHTML += row;
            });
        }
        //显示添加信息模态框
        function showAddModal() {
            document.getElementById('modalTitle').textContent = 'Add user information';
            document.getElementById('saveButton').textContent = 'Add';
            document.getElementById('studentForm').reset(); // 清空表单
            document.getElementById('studentModal').style.display = 'block';
        }

        // 监听添加事件
        document.getElementById('add').addEventListener('click', function() {
            showAddModal();
        });

        // 监听表单提交事件
        document.getElementById('studentForm').addEventListener('submit', function(event) {
            event.preventDefault(); // 阻止表单的默认提交行为

            // 获取表单数据
            const formData = new FormData(document.getElementById('studentForm'));
            const studentData = {};
            formData.forEach(function(value, key) {
                console.log(key + ": " + value); // 输出表单数据到控制台
                studentData[key] = value;
            });

            // 发起添加学生信息的请求
            fetch('http://localhost:8080/api/addStudent', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(studentData)
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('HTTP error ' + response.status);
                    }
                    return response.json()
                })
                .then(data => {
                    // 添加成功后的操作，例如关闭模态框并刷新学生数据
                    closeModal();
                    fetchAndRenderStudents();
                })
                .catch(error => console.error('Error adding student', error));
        });


        //获取表单元素，添加事件监听器
        document.getElementById('studentForm').addEventListener('submit', function(event) {
            event.preventDefault();
            var formData = new FormData(document.getElementById('studentForm'));
            var studentData = {};
            formData.forEach(function(value, key) {
                studentData[key] = value;
            });

            // 确保ID字段被正确地包含在表单数据中
            fetch('http://localhost:8080/api/updateStudent', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(studentData)
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('HTTP error ' + response.status);
                    }
                    return response.json()
                })
                .then(response => response.json())
                .then(data => {
                    closeModal();
                    fetch('http://localhost:8080/api/StuInfo')
                        .then(response => response.json())
                        .then(data => {
                            renderStudents(data);
                        })
                        .catch(error => console.error('Error fetching students', error));
                })
                .catch(error => console.error('Error saving student', error));
        });

        //关闭模态框
        function closeModal() {
            document.getElementById('studentModal').style.display = 'none';
        }

        function openEditModal(id) {
            document.getElementById('modalTitle').textContent = 'Update user information';
            document.getElementById('saveButton').textContent = 'Submit';
            // 根据id从后端获取学生信息并填充到模态框中
            fetch(`http://localhost:8080/getStudentById/${id}`)
                .then(response => response.json())
                .then(student => {
                    document.getElementById('id').value = student.id;
                    document.getElementById('username').value = student.username;
                    document.getElementById('position').value = student.position;
                    document.getElementById('mobilePhone').value = student.mobilePhone;
                    document.getElementById('gender').value = student.gender;
                    document.getElementById('schoolEmail').value = student.schoolEmail;
                    document.getElementById('emergencyContactNumber').value = student.emergencyContactNumber;
                    document.getElementById('studentModal').style.display = 'block';
                })
                .catch(error => console.error('Error fetching student', error));
        }

        // 监听所有class为delete-button的按钮点击事件
        document.querySelectorAll('.delete-button').forEach(button => {
            button.addEventListener('click', function() {
                const studentId = this.getAttribute('data-student-id');
                deleteStudent(studentId);
            });
        });

        // 删除学生信息
        function deleteStudent(id) {
            fetch(`http://localhost:8080/api/deleteStudent/${id}`, {
                method: 'DELETE'
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Error deleting student');
                    }
                    return response.json();
                })
                .then(() => {
                    fetchAndRenderStudents();
                })
                .catch(error => console.error('Error deleting student', error));
        }

        // 初始化页面时获取学生数据
        document.addEventListener('DOMContentLoaded', function() {
            fetchAndRenderStudents();
        });

        // 获取表单元素，添加事件监听器
        document.getElementById('studentForm').addEventListener('submit', function(event) {
            // ...略去部分代码，保留原有逻辑
            fetch('http://localhost:8080/api/updateStudent', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(studentData)
            }).then(response => {
                if (!response.ok) {
                    throw new Error('HTTP error ' + response.status);
                }
                return response.json()
            }).then(response => response.json())
                .then(data => {
                    closeModal();
                    fetchAndRenderStudents();
                }).catch(error => console.error('Error saving student', error));
        });

    </script>
</div>
</body>
</html>