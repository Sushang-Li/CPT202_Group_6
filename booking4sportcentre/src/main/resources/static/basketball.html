<!DOCTYPE html>
<html lang="en">

<head>



  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="css/timeandareaSelecting.css">
  <title>Welcome</title>

</head>

<body>

  <nav>
    <div class="nav-container">
      <div class="logo">
        <a href="userHomepage.html" id="logo-nav">:D</a>
      </div>
      <div class="homepage">
        <a href="userHomepage.html" id="homepage-nav">HOMEPAGE</a>
      </div>
      <div class="information">
        <a href="userInformation.html" id="information-nav">INFORMATION</a>
      </div>
      <div class="wallet">
        <a href="userWallet.html" id="wallet-nav">WALLET</a>
      </div>
      <div class="booking">
        <a href="userBooking.html" id="booking-nav">BOOKING</a>
      </div>
      <div class="statistics">
        <a href="userStatistics.html" id="statistics-nav">STATISTICS</a>
      </div>
    </div>
  </nav>

  <br>
  <label>
    <span>Selecting Date</span>
    <input type="date" id="date" value="" />
  </label>


  <h1>Selecting timeslot and area</Select></h1>

  <!-- 这里是一个表格，从sportActivity表得到现在还有票的活动 -->
  <table id="activity-table">
    <tr>
      <th>activityID</th>
      <th>activityName</th>
      <th>activityDate</th>
      <th>startTime</th>
      <th>endTime</th>
      <th>coach</th>
      <th>stadium</th>
      <th>price</th>
      <th>ticketNumber</th>
      <th>operation1</th>
      <th>operation2</th>
    </tr>



  </table>


  <script>

    //复制自主页
    var urlParams = new URLSearchParams(window.location.search);
    var userId = urlParams.get('id');
    console.log(userId);

    var userLink = document.getElementById('logo-nav');
    userLink.href = "userHomepage.html?id=" + userId;

    var userLink = document.getElementById('homepage-nav');
    userLink.href = "userHomepage.html?id=" + userId;

    var userLink = document.getElementById('information-nav');
    userLink.href = "userInformation.html?id=" + userId;

    var userLink = document.getElementById('wallet-nav');
    userLink.href = "userWallet.html?id=" + userId;

    var userLink = document.getElementById('booking-nav');
    userLink.href = "userBooking.html?id=" + userId;

    var userLink = document.getElementById('statistics-nav');
    userLink.href = "userStatistics.html?id=" + userId;


    function payForActivity(activity) {
      console.log(activity);  // 用于测试，将活动记录到控制台

      var actname = activity.name;
      var coachname = activity.coach;
      var date = activity.date;
      var starttime = activity.startTime;
      var endtime = activity.endTime;
      var price = activity.price;
      var position = activity.stadium;
      var uid = userId;

      //先新增一条未支付的预定
      fetch('http://localhost:8080/api/bookings/addTest1', {
        method: "POST",
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          userId: uid,
          date: date,
          startTime: starttime,
          endTime: endtime,
          venue: position,
          status: "PENDING",
          actName: actname,
          price: price
        })
      })
        .then(response => {
          if (response.status === 200) {
            return response.json(); // 返回响应数据
          } else {
            throw new Error('HTTP 错误 ' + response.status);
          }
        })
        .then(data => {
          alert("成功");
          console.log(data); // 记录任何接收到的响应数据
        })
        .catch(error => {
          console.log("错误：", error);
          alert("失败");
        });
    }


    function addToCart(activity) {
      console.log(activity);  // 用于测试，将活动记录到控制台

      var actname = activity.name;
      var coachname = activity.coach;
      var date = activity.date;
      var starttime = activity.startTime;
      var endtime = activity.endTime;
      var price = activity.price;
      var position = activity.stadium;
      var uid = userId;

      //先新增一条未支付的预定
      fetch('http://localhost:8080/api/bookings/addTest1', {
        method: "POST",
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          userId: uid,
          date: date,
          startTime: starttime,
          endTime: endtime,
          venue: position,
          status: "PENDING",
          actName: actname,
          price: price
        })
      })
        .then(response => {
          if (response.status === 200) {
            return response.json(); // 返回响应数据
          } else {
            throw new Error('HTTP 错误 ' + response.status);
          }
        })
        .then(data => {
          alert("成功");
          console.log(data); // 记录任何接收到的响应数据
        })
        .catch(error => {
          console.log("错误：", error);
          alert("失败");
        });
    }

    // 存储后端返回的活动表
    window.onload = function () {
      fetch('http://localhost:8080/api/test11', {
        method: 'GET'
      })
        .then((response) => response.json())
        .then((data) => {

          var table = document.getElementById('activity-table');
          data.forEach(activity => {
            //票数不为零的话就会显示出来,且活动名为basketball
            //我在这里找了一个小时的bug，发现是参数传递的问题
            if (activity.ticketNumber != 0 && activity.name === "basketball") {
              var row = document.createElement("tr");
              row.innerHTML = `
              <td id="activity-id-${activity.id}">${activity.id}</td>
              <td id="activity-name-${activity.name}">${activity.name}</td>
              <td id="activity-date-${activity.date}">${activity.date}</td>
              <td id="activity-startTime-${activity.startTime}">${activity.startTime}</td>
              <td id="activity-endTime-${activity.endTime}">${activity.endTime}</td>
              <td id="activity-coach-${activity.coach}">${activity.coach}</td>
              <td id="activity-stadium-${activity.stadium}">${activity.stadium}</td>
              <td id="activity-price-${activity.price}">${activity.price}</td>
              <td id="activity-number-${activity.ticketNumber}">${activity.ticketNumber}</td>
              <td id="activity-pay-${activity.id}">
              <button onclick="payForActivity(${JSON.stringify(activity).replace(/"/g, "&quot;")})">Pay</button>
              </td>
              <td id="activity-add-${activity.id}">
              <button button onclick="addToCart(${JSON.stringify(activity).replace(/"/g, "&quot;")})">Add to Cart</button>
              </td>
              
              `;

              table.appendChild(row);

            }
          });






        })
    }



    var d = new Date()
    var day = d.getDate()
    var month = d.getMonth() + 1
    var year = d.getFullYear()
    var shijian = year + "-" + (month < 10 ? "0" : "") + month + "-" + (day < 10 ? "0" : "") + day;
    document.getElementById("date").value = shijian;



    function selectTimeAndLocation(time, location) {
      const dateControl = document.querySelector('input[type="date"]');
      // 在这里处理用户选择的时间和场地



      if (confirm('Choosing date: ' + dateControl.value + '\n' + 'Choosing time slot：' + time + "\n" + 'Choosing area：' + location)) {
        window.location.href = 'bookingpay.html' + '?id=' + userId
      }
    }


    var btn = document.querySelectorAll('button')
    btn.onclick = () => {
      fetch('http://localhost:8080/api/createBooking', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          startTime: '2022-01-01T09:00:00',
          endTime: '2022-01-01T11:00:00',
          date: dateControl.value,
          venue: location,
          actName: 'basketball',
          price: 20,

        })
          .then(response => {
            if (!response.ok) {
              throw new Error('HTTP error ' + response.status);
            }
            return response.json()
          })
      })
        .then(response => {
          if (!response.ok) {
            throw new Error('HTTP error ' + response.status);
          }
          return response.json()
        })
        .then(data => {
          // 添加成功后的操作，关闭模态框并刷新用户数据
          console.log('data')
        })
        .catch(error => console.error('Error adding booking', error));
    }


  </script>
</body>

</html>